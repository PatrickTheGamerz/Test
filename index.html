<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>C++ Block Builder â€“ Console Style</title>
<style>
  * { box-sizing: border-box; }

  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: #1e1e2e;
    color: #cdd6f4;
    display: flex;
    height: 100vh;
    overflow: hidden;
  }

  #sidebar {
    width: 260px;
    background: #11111b;
    border-right: 2px solid #313244;
    padding: 12px;
    overflow-y: auto;
  }

  #sidebar h2 {
    margin-top: 0;
    font-size: 18px;
    color: #89b4fa;
  }

  .category h3 {
    margin: 10px 0 4px;
    font-size: 14px;
    color: #b4befe;
  }

  .palette-block {
    background: linear-gradient(135deg, #45475a, #585b70);
    border-radius: 10px;
    padding: 8px 10px;
    margin: 6px 0;
    cursor: grab;
    font-size: 13px;
    color: #f5e0dc;
    box-shadow: 0 3px 6px #0005;
    transition: transform .1s;
  }

  .palette-block:hover {
    transform: scale(1.03);
  }

  .palette-block input,
  .palette-block select {
    font-size: 12px;
    width: 80px;
    margin-left: 4px;
    background: #2b2b3c;
    color: #f5e0dc;
    border: 1px solid #45475a;
    border-radius: 4px;
    padding: 2px 4px;
  }

  #workspace {
    flex: 1;
    display: flex;
    padding: 10px;
    gap: 10px;
  }

  #scriptArea {
    flex: 1;
    background: #181825;
    border-radius: 10px;
    padding: 10px;
    overflow-y: auto;
    border: 1px solid #313244;
  }

  .script-block {
    background: linear-gradient(135deg, #313244, #45475a);
    border-radius: 10px;
    padding: 8px 10px;
    margin: 6px 0;
    font-size: 13px;
    color: #f5e0dc;
    box-shadow: 0 3px 6px #0005;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .script-block .handle {
    width: 10px;
    height: 24px;
    border-radius: 4px;
    background: #585b70;
    cursor: grab;
  }

  .script-block-inner {
    flex: 1;
  }

  .script-block input,
  .script-block select {
    font-size: 12px;
    width: 80px;
    margin-left: 4px;
    background: #2b2b3c;
    color: #f5e0dc;
    border: 1px solid #45475a;
    border-radius: 4px;
    padding: 2px 4px;
  }

  .remove-btn {
    background: #f38ba8;
    border: none;
    border-radius: 4px;
    font-size: 10px;
    padding: 2px 6px;
    cursor: pointer;
  }

  .remove-btn:hover {
    background: #f9e2af;
    color: #11111b;
  }

  .drop-indicator {
    height: 4px;
    border-radius: 2px;
    background: #89b4fa;
    margin: 2px 0;
  }

  #rightPane {
    width: 460px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  #cppCode, #console {
    background: #11111b;
    border-radius: 10px;
    padding: 10px;
    border: 1px solid #313244;
    font-family: "JetBrains Mono", monospace;
    font-size: 12px;
    white-space: pre-wrap;
    overflow-y: auto;
    max-height: 40vh;
  }

  #console {
    max-height: 30vh;
  }

  #consoleInputBar {
    display: flex;
    gap: 6px;
    margin-top: 4px;
  }

  #consoleInput {
    flex: 1;
    background: #2b2b3c;
    color: #f5e0dc;
    border: 1px solid #45475a;
    border-radius: 4px;
    padding: 4px 6px;
    font-family: "JetBrains Mono", monospace;
    font-size: 12px;
  }

  #controls {
    background: #11111b;
    border-radius: 10px;
    padding: 10px;
    border: 1px solid #313244;
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .btn {
    background: #89b4fa;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    cursor: pointer;
    font-size: 14px;
    color: #11111b;
    font-weight: bold;
  }

  .btn:hover {
    background: #b4befe;
  }

  .btn-secondary {
    background: #45475a;
    color: #cdd6f4;
  }

  .btn-secondary:hover {
    background: #585b70;
  }
</style>
</head>
<body>

<div id="sidebar">
  <h2>Blocks</h2>

  <div class="category">
    <h3>Program</h3>
    <div class="palette-block" draggable="true" data-type="programbase"
         title="Adds #include lines, using namespace std; and int main(). Must be the first block.">
      using namespace std; (basic C++ setup)
    </div>
  </div>

  <div class="category">
    <h3>Variables</h3>
    <div class="palette-block" draggable="true" data-type="intdecl"
         title="Declare an int variable with an initial value.">
      int <input type="text" value="age"> = <input type="number" value="16">;
    </div>
    <div class="palette-block" draggable="true" data-type="doubledecl"
         title="Declare a double variable with an initial value.">
      double <input type="text" value="price"> = <input type="text" value="19.99">;
    </div>
    <div class="palette-block" draggable="true" data-type="chardecl"
         title="Declare a char variable with a single character.">
      char <input type="text" value="letter"> = '<input type="text" value="A" maxlength="1">';
    </div>
    <div class="palette-block" draggable="true" data-type="stringdecl"
         title="Declare a string variable with an initial text.">
      string <input type="text" value="name"> = "<input type="text" value="Roksana">";
    </div>
    <div class="palette-block" draggable="true" data-type="booldecl"
         title="Declare a bool variable (true or false).">
      bool <input type="text" value="isSmart"> = 
      <select>
        <option value="true">true</option>
        <option value="false">false</option>
      </select>;
    </div>
    <div class="palette-block" draggable="true" data-type="assign"
         title="Assign a new value or expression to an existing variable.">
      <input type="text" value="age"> = <input type="text" value="age + 1">;
    </div>
  </div>

  <div class="category">
    <h3>Print</h3>
    <div class="palette-block" draggable="true" data-type="print"
         title="Print text without a newline at the end.">
      cout &lt;&lt; "<input type="text" value="text">";
    </div>
    <div class="palette-block" draggable="true" data-type="printline"
         title="Print text followed by a newline (endl).">
      cout &lt;&lt; "<input type="text" value="text">" &lt;&lt; endl;
    </div>
    <div class="palette-block" draggable="true" data-type="printvar"
         title="Print the value of a variable followed by a newline.">
      cout &lt;&lt; <input type="text" value="age"> &lt;&lt; endl;
    </div>
  </div>

  <div class="category">
    <h3>Input</h3>
    <div class="palette-block" draggable="true" data-type="inputprompt"
         title="Show a prompt before reading input (cin).">
      cout &lt;&lt; "<input type="text" value="Enter a number: ">";
    </div>
    <div class="palette-block" draggable="true" data-type="inputint"
         title="Read an int value from input into a variable (cin).">
      cin &gt;&gt; <input type="text" value="number">;
    </div>
    <div class="palette-block" draggable="true" data-type="inputprompt"
         title="Show a prompt before reading a string.">
      cout &lt;&lt; "<input type="text" value="Enter your name: ">";
    </div>
    <div class="palette-block" draggable="true" data-type="inputstring"
         title="Read a string value from input into a variable (cin).">
      cin &gt;&gt; <input type="text" value="name">;
    </div>
  </div>

  <div class="category">
    <h3>Math</h3>
    <div class="palette-block" draggable="true" data-type="mathprint"
         title="Print a label and the result of an expression.">
      cout &lt;&lt; "<input type="text" value="a + b = ">" &lt;&lt; <input type="text" value="a + b"> &lt;&lt; endl;
    </div>
  </div>

  <div class="category">
    <h3>Logic</h3>
    <div class="palette-block" draggable="true" data-type="if"
         title="Start an if block with a condition. Needs a closing } block.">
      if (<input type="text" value="number > 0">) {
    </div>
    <div class="palette-block" draggable="true" data-type="elseif"
         title="Else-if block, used after an if or another else-if.">
      else if (<input type="text" value="number < 0">) {
    </div>
    <div class="palette-block" draggable="true" data-type="else"
         title="Else block, used after if/else-if.">
      else {
    </div>
    <div class="palette-block" draggable="true" data-type="end"
         title="Closing block for if/else/loops (adds }).">
      }
    </div>
  </div>

  <div class="category">
    <h3>Loops</h3>
    <div class="palette-block" draggable="true" data-type="for"
         title="Classic for loop with start, end and increment. Needs closing }.">
      for (int <input type="text" value="i"> = <input type="number" value="1">; <input type="text" value="i"> &lt;= <input type="number" value="5">; <input type="text" value="i">++) {
    </div>
    <div class="palette-block" draggable="true" data-type="while"
         title="While loop that repeats while the condition is true. Needs closing }.">
      while (<input type="text" value="i <= 5">) {
    </div>
    <div class="palette-block" draggable="true" data-type="end"
         title="Closing block for loops or if/else (adds }).">
      }
    </div>
  </div>

  <div class="category">
    <h3>Arrays & Functions</h3>
    <div class="palette-block" draggable="true" data-type="arraydecl"
         title="Declare a simple int array with 5 elements.">
      int <input type="text" value="arr">[5] = {1,2,3,4,5};
    </div>
    <div class="palette-block" draggable="true" data-type="rangefor"
         title="Range-based for loop over an array. Needs closing }.">
      for (int <input type="text" value="x"> : <input type="text" value="arr">) {
    </div>
    <div class="palette-block" draggable="true" data-type="callgreet"
         title="Call greet(name). greet() is auto-added if used.">
      greet(<input type="text" value="name">);
    </div>
  </div>
</div>

<div id="workspace">
  <div id="scriptArea">
    <!-- script blocks go here -->
  </div>

  <div id="rightPane">
    <div id="cppCode"></div>

    <div id="console">
      (program output will appear here)
    </div>
    <div id="consoleInputBar">
      <input id="consoleInput" type="text"
             placeholder="inputs for cin (one per line, before Run). After run, input is locked."
             autocomplete="off">
    </div>

    <div id="controls">
      <button class="btn" id="runBtn">Run Program</button>
      <button class="btn" id="clearBtn">CLEAR SCRIPT</button>
      <button class="btn btn-secondary" id="saveBtn">Save Script</button>
      <button class="btn btn-secondary" id="loadBtn">Load Script</button>
      <input type="file" id="fileInput" accept=".json" style="display:none;">
    </div>
  </div>
</div>

<script>
  const scriptArea = document.getElementById("scriptArea");
  const cppCodeEl = document.getElementById("cppCode");
  const consoleEl = document.getElementById("console");
  const consoleInput = document.getElementById("consoleInput");
  const runBtn = document.getElementById("runBtn");
  const clearBtn = document.getElementById("clearBtn");
  const saveBtn = document.getElementById("saveBtn");
  const loadBtn = document.getElementById("loadBtn");
  const fileInput = document.getElementById("fileInput");

  let scriptBlocks = [];
  let dragData = { type: null, index: -1 };
  let currentDropIndex = -1;
  let dropIndicator = null;

  // console coloring helpers
  let consoleBuffer = "";

  function resetConsole() {
    consoleBuffer = "";
    consoleEl.innerHTML = '<span style="color:#ffffff;">(program output will appear here)</span>';
  }

  function flushConsole() {
    if (!consoleBuffer) {
      consoleEl.innerHTML = '<span style="color:#ffffff;">(no output)</span>';
    } else {
      consoleEl.innerHTML = consoleBuffer;
    }
  }

  function logNormal(text) {
    if (!text) return;
    consoleBuffer += `<span style="color:#ffffff;">${escapeHtml(text)}</span>`;
  }

  function logNormalLine(text) {
    logNormal(text + "\n");
  }

  function logError(text) {
    if (!text) return;
    consoleBuffer += `<span style="color:#f38ba8;">${escapeHtml(text)}</span>`;
  }

  function logErrorLine(text) {
    logError(text + "\n");
  }

  function logWarning(text) {
    if (!text) return;
    consoleBuffer += `<span style="color:#f9e2af;">${escapeHtml(text)}</span>`;
  }

  function logWarningLine(text) {
    logWarning(text + "\n");
  }

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  function createDropIndicator() {
    const div = document.createElement("div");
    div.className = "drop-indicator";
    return div;
  }

  function refreshDropIndicator() {
    if (dropIndicator && dropIndicator.parentElement) {
      dropIndicator.parentElement.removeChild(dropIndicator);
    }
    dropIndicator = createDropIndicator();
    const blocks = [...scriptArea.querySelectorAll(".script-block")];
    if (currentDropIndex < 0 || currentDropIndex > blocks.length) return;
    if (blocks.length === 0 || currentDropIndex === blocks.length) {
      scriptArea.appendChild(dropIndicator);
    } else {
      scriptArea.insertBefore(dropIndicator, blocks[currentDropIndex]);
    }
  }

  document.addEventListener("dragstart", e => {
    const palette = e.target.closest(".palette-block");
    const scriptBlock = e.target.closest(".script-block");
    if (palette) {
      dragData.type = "palette";
      dragData.index = -1;
    } else if (scriptBlock) {
      dragData.type = "script";
      dragData.index = scriptBlocks.findIndex(b => b.el === scriptBlock);
    } else {
      dragData.type = null;
    }
  });

  document.addEventListener("dragend", () => {
    dragData.type = null;
    dragData.index = -1;
    currentDropIndex = -1;
    if (dropIndicator && dropIndicator.parentElement) {
      dropIndicator.parentElement.removeChild(dropIndicator);
    }
  });

  scriptArea.addEventListener("dragover", e => {
    e.preventDefault();
    const blocks = [...scriptArea.querySelectorAll(".script-block")];
    let idx = blocks.length;
    for (let i = 0; i < blocks.length; i++) {
      const rect = blocks[i].getBoundingClientRect();
      if (e.clientY < rect.top + rect.height / 2) {
        idx = i;
        break;
      }
    }
    currentDropIndex = idx;
    refreshDropIndicator();
  });

  scriptArea.addEventListener("drop", e => {
    e.preventDefault();
    if (!dragData.type) return;

    if (dragData.type === "palette") {
      const paletteBlock = document.querySelector(".palette-block:hover");
      if (!paletteBlock) return;
      const newBlock = makeScriptBlockFromPalette(paletteBlock);
      insertScriptBlock(newBlock, currentDropIndex);
    } else if (dragData.type === "script" && dragData.index >= 0) {
      const moving = scriptBlocks[dragData.index];
      scriptBlocks.splice(dragData.index, 1);
      let insertIndex = currentDropIndex;
      if (insertIndex > scriptBlocks.length) insertIndex = scriptBlocks.length;
      scriptBlocks.splice(insertIndex, 0, moving);
      renderScriptBlocks();
    }

    currentDropIndex = -1;
    if (dropIndicator && dropIndicator.parentElement) {
      dropIndicator.parentElement.removeChild(dropIndicator);
    }
    updateCpp();
  });

  function makeScriptBlockFromPalette(paletteBlock) {
    const type = paletteBlock.dataset.type;
    const wrapper = document.createElement("div");
    wrapper.className = "script-block";
    wrapper.draggable = true;

    const handle = document.createElement("div");
    handle.className = "handle";
    wrapper.appendChild(handle);

    const inner = document.createElement("div");
    inner.className = "script-block-inner";
    inner.innerHTML = paletteBlock.innerHTML;
    wrapper.appendChild(inner);

    const remove = document.createElement("button");
    remove.className = "remove-btn";
    remove.textContent = "x";
    remove.onclick = () => {
      scriptBlocks = scriptBlocks.filter(b => b.el !== wrapper);
      renderScriptBlocks();
      updateCpp();
    };
    wrapper.appendChild(remove);

    wrapper.addEventListener("dragstart", () => {
      dragData.type = "script";
      dragData.index = scriptBlocks.findIndex(b => b.el === wrapper);
    });

    return { el: wrapper, type, getValues: () => readValues(inner) };
  }

  function insertScriptBlock(blockObj, index) {
    if (index < 0 || index > scriptBlocks.length) index = scriptBlocks.length;
    scriptBlocks.splice(index, 0, blockObj);
    renderScriptBlocks();
  }

  function renderScriptBlocks() {
    scriptArea.querySelectorAll(".script-block").forEach(b => b.remove());
    scriptBlocks.forEach(b => scriptArea.appendChild(b.el));
  }

  function readValues(container) {
    return [...container.querySelectorAll("input, select")].map(x => x.value);
  }

  function validateScript() {
    if (scriptBlocks.length === 0) {
      return { ok: false, message: "Error: No blocks placed." };
    }

    const hasProgramBase = scriptBlocks.some(b => b.type === "programbase");
    if (!hasProgramBase) {
      return { ok: false, message: "Error: Missing program setup block (using namespace std;)." };
    }

    if (scriptBlocks[0].type !== "programbase") {
      return { ok: false, message: "Error: Program setup block must be the first block." };
    }

    let depth = 0;
    for (let i = 0; i < scriptBlocks.length; i++) {
      const t = scriptBlocks[i].type;
      if (["if","elseif","else","for","while","rangefor"].includes(t)) {
        depth++;
      } else if (t === "end") {
        depth--;
        if (depth < 0) {
          return { ok: false, message: "Error: Extra closing block '}' near block #" + (i + 1) + "." };
        }
      }
    }
    if (depth > 0) {
      return { ok: false, message: "Error: Missing closing block '}' for one or more structures." };
    }

    // variable existence check
    const declared = new Set();
    scriptBlocks.forEach(b => {
      const t = b.type;
      const v = b.getValues();
      if (t === "intdecl" || t === "doubledecl" || t === "chardecl" ||
          t === "stringdecl" || t === "booldecl" || t === "arraydecl") {
        if (v[0]) declared.add(v[0]);
      }
    });

    for (let i = 0; i < scriptBlocks.length; i++) {
      const b = scriptBlocks[i];
      const t = b.type;
      const v = b.getValues();
      if (t === "assign") {
        const name = v[0];
        if (name && !declared.has(name)) {
          return { ok: false, message: "Error: Variable '" + name + "' used in assignment before declaration (block #" + (i + 1) + ")." };
        }
      } else if (t === "printvar") {
        const name = v[0];
        if (name && !declared.has(name)) {
          return { ok: false, message: "Error: Variable '" + name + "' printed before declaration (block #" + (i + 1) + ")." };
        }
      } else if (t === "inputint" || t === "inputstring") {
        const name = v[0];
        if (name && !declared.has(name)) {
          return { ok: false, message: "Error: Variable '" + name + "' used in cin before declaration (block #" + (i + 1) + ")." };
        }
      }
    }

    return { ok: true, message: "" };
  }

  function generateCpp() {
    if (scriptBlocks.length === 0) return "";

    const hasProgramBase = scriptBlocks.some(b => b.type === "programbase");
    const usesGreet = scriptBlocks.some(b => b.type === "callgreet");

    let code = "";

    if (hasProgramBase) {
      code += "#include <iostream>\n";
      code += "#include <string>\n";
      code += "using namespace std;\n\n";
      if (usesGreet) {
        code += "void greet(string name) {\n";
        code += "    cout << \"Hello, \" << name << \"!\" << endl;\n";
        code += "}\n\n";
      }
      code += "int main() {\n";
    }

    let indent = hasProgramBase ? 1 : 0;
    const tab = () => "    ".repeat(indent);

    scriptBlocks.forEach(b => {
      const t = b.type;
      const v = b.getValues();

      if (t === "programbase") {
        // no direct code, just enables includes/main
      } else if (t === "print") {
        code += tab() + `cout << "${v[0]}";\n`;
      } else if (t === "printline") {
        code += tab() + `cout << "${v[0]}" << endl;\n`;
      } else if (t === "printvar") {
        code += tab() + `cout << ${v[0]} << endl;\n`;
      } else if (t === "callgreet") {
        code += tab() + `greet(${v[0]});\n`;
      } else if (t === "intdecl") {
        code += tab() + `int ${v[0]} = ${v[1]};\n`;
      } else if (t === "doubledecl") {
        code += tab() + `double ${v[0]} = ${v[1]};\n`;
      } else if (t === "chardecl") {
        code += tab() + `char ${v[0]} = '${(v[1] || "A")[0]}';\n`;
      } else if (t === "stringdecl") {
        code += tab() + `string ${v[0]} = "${v[1]}";\n`;
      } else if (t === "booldecl") {
        code += tab() + `bool ${v[0]} = ${v[1]};\n`;
      } else if (t === "assign") {
        code += tab() + `${v[0]} = ${v[1]};\n`;
      } else if (t === "inputprompt") {
        code += tab() + `cout << "${v[0]}";\n`;
      } else if (t === "inputint") {
        code += tab() + `cin >> ${v[0]};\n`;
      } else if (t === "inputstring") {
        code += tab() + `cin >> ${v[0]};\n`;
      } else if (t === "mathprint") {
        code += tab() + `cout << "${v[0]}" << ${v[1]} << endl;\n`;
      } else if (t === "if") {
        code += tab() + `if (${v[0]}) {\n`;
        indent++;
      } else if (t === "elseif") {
        indent--;
        code += tab() + `else if (${v[0]}) {\n`;
        indent++;
      } else if (t === "else") {
        indent--;
        code += tab() + "else {\n";
        indent++;
      } else if (t === "for") {
        const varName = v[0] || "i";
        const start = v[1] || "1";
        const end = v[2] || "5";
        const name2 = v[3] || varName;
        code += tab() + `for (int ${varName} = ${start}; ${name2} <= ${end}; ${name2}++) {\n`;
        indent++;
      } else if (t === "while") {
        code += tab() + `while (${v[0]}) {\n`;
        indent++;
      } else if (t === "arraydecl") {
        code += tab() + `int ${v[0]}[5] = {1,2,3,4,5};\n`;
      } else if (t === "rangefor") {
        code += tab() + `for (int ${v[0]} : ${v[1]}) {\n`;
        indent++;
      } else if (t === "end") {
        indent = Math.max(hasProgramBase ? 1 : 0, indent - 1);
        code += tab() + "}\n";
      }
    });

    if (hasProgramBase) {
      code += "    return 0;\n";
      code += "}\n";
    }

    return code;
  }

  function simulateRun() {
    consoleBuffer = "";

    let env = {
      int: {},
      double: {},
      char: {},
      string: {},
      bool: {}
    };

    let inputQueue = [];

    function getVal(expr) {
      try {
        const scope = {};
        Object.keys(env.int).forEach(k => scope[k] = env.int[k]);
        Object.keys(env.double).forEach(k => scope[k] = env.double[k]);
        Object.keys(env.bool).forEach(k => scope[k] = env.bool[k]);
        Object.keys(env.string).forEach(k => scope[k] = env.string[k]);
        const fn = new Function(...Object.keys(scope), "return " + expr + ";");
        return fn(...Object.values(scope));
      } catch {
        throw new Error("Runtime error in expression: " + expr);
      }
    }

    function nextInput() {
      if (inputQueue.length === 0) {
        throw new Error("Runtime error: cin requested but no more input lines.");
      }
      return inputQueue.shift();
    }

    function execBlocks(blocks, start = 0, end = blocks.length) {
      let i = start;
      while (i < end) {
        const b = blocks[i];
        const t = b.type;
        const v = b.getValues();

        try {
          if (t === "programbase") {
            // no runtime effect
          } else if (t === "print") {
            logNormal(v[0]);
          } else if (t === "printline") {
            logNormalLine(v[0]);
          } else if (t === "printvar") {
            const name = v[0];
            let val = env.int[name];
            if (val === undefined) val = env.double[name];
            if (val === undefined) val = env.bool[name];
            if (val === undefined) val = env.string[name];
            if (val === undefined) val = env.char[name];
            if (val === undefined) {
              throw new Error("Runtime error: variable '" + name + "' has no value.");
            }
            logNormalLine(String(val));
          } else if (t === "callgreet") {
            const name = v[0];
            let val = env.string[name] ?? name;
            logNormalLine("Hello, " + val + "!");
          } else if (t === "intdecl") {
            env.int[v[0]] = Number(v[1]) || 0;
          } else if (t === "doubledecl") {
            env.double[v[0]] = Number(v[1]) || 0;
          } else if (t === "chardecl") {
            env.char[v[0]] = (v[1] || "A")[0];
          } else if (t === "stringdecl") {
            env.string[v[0]] = v[1];
          } else if (t === "booldecl") {
            env.bool[v[0]] = (v[1] === "true");
          } else if (t === "assign") {
            const name = v[0];
            const val = getVal(v[1]);
            if (name in env.int) env.int[name] = Number(val);
            else if (name in env.double) env.double[name] = Number(val);
            else if (name in env.bool) env.bool[name] = !!val;
            else if (name in env.string) env.string[name] = String(val);
            else if (name in env.char) env.char[name] = String(val)[0];
            else throw new Error("Runtime error: variable '" + name + "' not declared.");
          } else if (t === "inputprompt") {
            logNormal(v[0]);
          } else if (t === "inputint") {
            const name = v[0];
            const raw = nextInput();
            logNormalLine(raw);
            const num = Number(raw);
            if (Number.isNaN(num)) {
              throw new Error("Runtime error: input '" + raw + "' is not a valid number for '" + name + "'.");
            }
            env.int[name] = num;
          } else if (t === "inputstring") {
            const name = v[0];
            const raw = nextInput();
            logNormalLine(raw);
            env.string[name] = raw;
          } else if (t === "mathprint") {
            const label = v[0];
            const val = getVal(v[1]);
            logNormalLine(label + String(val));
          } else if (t === "if" || t === "elseif" || t === "else" ||
                     t === "for" || t === "while" || t === "rangefor") {
            let depth = 0;
            let j = i + 1;
            for (; j < end; j++) {
              const tt = blocks[j].type;
              if (["if","elseif","else","for","while","rangefor"].includes(tt)) depth++;
              if (tt === "end") {
                if (depth === 0) break;
                depth--;
              }
            }
            const bodyStart = i + 1;
            const bodyEnd = j;

            if (t === "if" || t === "elseif") {
              let cond = !!getVal(v[0]);
              if (cond) {
                execBlocks(blocks, bodyStart, bodyEnd);
                i = j;
              } else {
                i++;
                continue;
              }
            } else if (t === "else") {
              execBlocks(blocks, bodyStart, bodyEnd);
              i = j;
            } else if (t === "for") {
              const varName = v[0] || "i";
              const startVal = Number(v[1]) || 1;
              const endVal = Number(v[2]) || 5;
              env.int[varName] = startVal;
              for (; env.int[varName] <= endVal; env.int[varName]++) {
                execBlocks(blocks, bodyStart, bodyEnd);
              }
              i = j;
            } else if (t === "while") {
              while (getVal(v[0])) {
                execBlocks(blocks, bodyStart, bodyEnd);
              }
              i = j;
            } else if (t === "rangefor") {
              const varName = v[0] || "x";
              const arrName = v[1] || "arr";
              const arr = [1,2,3,4,5];
              env.int[varName] = 0;
              for (let val of arr) {
                env.int[varName] = val;
                execBlocks(blocks, bodyStart, bodyEnd);
              }
              i = j;
            }
          }
        } catch (err) {
          logErrorLine(String(err.message || err));
          return; // stop at first runtime error
        }
        i++;
      }
    }

    const rawInput = consoleInput.value.trim();
    if (rawInput.length > 0) {
      inputQueue = rawInput.split(/\r?\n/);
    } else {
      inputQueue = [];
    }

    execBlocks(scriptBlocks);
    flushConsole();
  }

  function updateCpp() {
    cppCodeEl.textContent = generateCpp();
  }

  function runProgram() {
    const validation = validateScript();
    if (!validation.ok) {
      consoleBuffer = "";
      logErrorLine(validation.message);
      flushConsole();
      cppCodeEl.textContent = generateCpp();
      return;
    }
    consoleInput.disabled = true;
    updateCpp();
    simulateRun();
  }

  runBtn.addEventListener("click", () => {
    runProgram();
  });

  clearBtn.addEventListener("click", () => {
    scriptBlocks = [];
    renderScriptBlocks();
    cppCodeEl.textContent = "";
    resetConsole();
    consoleInput.value = "";
    consoleInput.disabled = false;
  });

  consoleInput.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      e.preventDefault();
      runProgram();
    }
  });

  // saving/loading
  function serializeScript() {
    return scriptBlocks.map(b => ({
      type: b.type,
      values: b.getValues()
    }));
  }

  function deserializeScript(data) {
    scriptBlocks = [];
    data.forEach(item => {
      const palette = document.querySelector(`.palette-block[data-type="${item.type}"]`);
      if (!palette) return;
      const block = makeScriptBlockFromPalette(palette);
      // set values
      const inputs = block.el.querySelectorAll(".script-block-inner input, .script-block-inner select");
      item.values.forEach((val, idx) => {
        if (inputs[idx]) inputs[idx].value = val;
      });
      scriptBlocks.push(block);
    });
    renderScriptBlocks();
    updateCpp();
  }

  saveBtn.addEventListener("click", () => {
    const data = serializeScript();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "cpp_block_script.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  loadBtn.addEventListener("click", () => {
    fileInput.click();
  });

  fileInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const data = JSON.parse(ev.target.result);
        if (Array.isArray(data)) {
          deserializeScript(data);
          resetConsole();
          consoleInput.value = "";
          consoleInput.disabled = false;
        } else {
          alert("Invalid script file.");
        }
      } catch {
        alert("Failed to load script file.");
      }
    };
    reader.readAsText(file);
    fileInput.value = "";
  });

  resetConsole();
  cppCodeEl.textContent = "";
</script>

</body>
</html>
