<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>C++ Block Builder</title>
<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: #1e1e2e;
    color: #cdd6f4;
    display: flex;
    height: 100vh;
    overflow: hidden;
    user-select: none;
  }

  input, select {
    user-select: text;
  }

  #sidebar {
    width: 260px;
    background: #11111b;
    border-right: 2px solid #313244;
    padding: 12px;
    overflow-y: auto;
  }

  #sidebar h2 {
    margin-top: 0;
    font-size: 18px;
    color: #89b4fa;
  }

  .category h3 {
    margin: 10px 0 4px;
    font-size: 14px;
    color: #b4befe;
  }

  .palette-block {
    background: linear-gradient(135deg, #45475a, #585b70);
    border-radius: 10px;
    padding: 8px 10px;
    margin: 6px 0;
    cursor: grab;
    font-size: 13px;
    color: #f5e0dc;
    box-shadow: 0 3px 6px #0005;
    transition: transform .1s;
  }

  .palette-block:hover {
    transform: scale(1.03);
  }

  .palette-block input,
  .palette-block select {
    font-size: 12px;
    width: 70px;
    margin-left: 4px;
  }

  #workspace {
    flex: 1;
    display: flex;
    padding: 10px;
    gap: 10px;
  }

  #scriptArea {
    flex: 1;
    background: #181825;
    border-radius: 10px;
    padding: 10px;
    overflow-y: auto;
    border: 1px solid #313244;
  }

  #scriptArea h3 {
    margin-top: 0;
    color: #89b4fa;
  }

  .script-block {
    background: linear-gradient(135deg, #313244, #45475a);
    border-radius: 10px;
    padding: 8px 10px;
    margin: 6px 0;
    font-size: 13px;
    color: #f5e0dc;
    box-shadow: 0 3px 6px #0005;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .script-block .handle {
    width: 10px;
    height: 24px;
    border-radius: 4px;
    background: #585b70;
    cursor: grab;
  }

  .script-block-inner {
    flex: 1;
  }

  .script-block input,
  .script-block select {
    font-size: 12px;
    width: 70px;
    margin-left: 4px;
  }

  .remove-btn {
    background: #f38ba8;
    border: none;
    border-radius: 4px;
    font-size: 10px;
    padding: 2px 5px;
    cursor: pointer;
  }

  .drop-indicator {
    height: 4px;
    border-radius: 2px;
    background: #89b4fa;
    margin: 2px 0;
  }

  #rightPane {
    width: 420px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  #cppCode, #output {
    background: #11111b;
    border-radius: 10px;
    padding: 10px;
    border: 1px solid #313244;
    font-family: "JetBrains Mono", monospace;
    font-size: 12px;
    white-space: pre-wrap;
    overflow-y: auto;
    max-height: 40vh;
    pointer-events: none;
  }

  #output {
    max-height: 25vh;
  }

  #controls {
    background: #11111b;
    border-radius: 10px;
    padding: 10px;
    border: 1px solid #313244;
    display: flex;
    justify-content: center;
    gap: 10px;
  }

  .btn {
    background: #89b4fa;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    cursor: pointer;
    font-size: 14px;
    color: #11111b;
    font-weight: bold;
  }

  .btn:hover {
    background: #b4befe;
  }
</style>
</head>
<body>

<div id="sidebar">
  <h2>Blocks</h2>

  <div class="category">
    <h3>Program</h3>
    <div class="palette-block" draggable="true" data-type="print">
      cout &lt;&lt; "<input type="text" value="text">";
    </div>
    <div class="palette-block" draggable="true" data-type="printline">
      cout &lt;&lt; "<input type="text" value="text">" &lt;&lt; endl;
    </div>
    <div class="palette-block" draggable="true" data-type="printvar">
      cout &lt;&lt; <input type="text" value="name"> &lt;&lt; endl;
    </div>
    <div class="palette-block" draggable="true" data-type="callgreet">
      greet(<input type="text" value="name">);
    </div>
  </div>

  <div class="category">
    <h3>Variables</h3>
    <div class="palette-block" draggable="true" data-type="intdecl">
      int <input type="text" value="age"> = <input type="number" value="16">;
    </div>
    <div class="palette-block" draggable="true" data-type="doubledecl">
      double <input type="text" value="price"> = <input type="text" value="19.99">;
    </div>
    <div class="palette-block" draggable="true" data-type="chardecl">
      char <input type="text" value="letter"> = '<input type="text" value="A" maxlength="1">';
    </div>
    <div class="palette-block" draggable="true" data-type="stringdecl">
      string <input type="text" value="name"> = "<input type="text" value="Roksana">";
    </div>
    <div class="palette-block" draggable="true" data-type="booldecl">
      bool <input type="text" value="isSmart"> = <select>
        <option value="true">true</option>
        <option value="false">false</option>
      </select>;
    </div>
    <div class="palette-block" draggable="true" data-type="assign">
      <input type="text" value="a"> = <input type="text" value="a+1">;
    </div>
  </div>

  <div class="category">
    <h3>Input</h3>
    <div class="palette-block" draggable="true" data-type="inputint">
      cin &gt;&gt; <input type="text" value="number">;
    </div>
    <div class="palette-block" draggable="true" data-type="inputprompt">
      cout &lt;&lt; "<input type="text" value="Enter a number: ">";
    </div>
  </div>

  <div class="category">
    <h3>Math</h3>
    <div class="palette-block" draggable="true" data-type="mathprint">
      cout &lt;&lt; "<input type="text" value="a + b = ">" &lt;&lt; <input type="text" value="a + b"> &lt;&lt; endl;
    </div>
  </div>

  <div class="category">
    <h3>Control</h3>
    <div class="palette-block" draggable="true" data-type="if">
      if (<input type="text" value="number > 0">) {
    </div>
    <div class="palette-block" draggable="true" data-type="elseif">
      else if (<input type="text" value="number < 0">) {
    </div>
    <div class="palette-block" draggable="true" data-type="else">
      else {
    </div>
    <div class="palette-block" draggable="true" data-type="for">
      for (int <input type="text" value="i"> = <input type="number" value="1">; <input type="text" value="i"> &lt;= <input type="number" value="5">; <input type="text" value="i">++) {
    </div>
    <div class="palette-block" draggable="true" data-type="while">
      while (<input type="text" value="i <= 5">) {
    </div>
    <div class="palette-block" draggable="true" data-type="end">
      }
    </div>
  </div>

  <div class="category">
    <h3>Arrays</h3>
    <div class="palette-block" draggable="true" data-type="arraydecl">
      int <input type="text" value="arr">[5] = {1,2,3,4,5};
    </div>
    <div class="palette-block" draggable="true" data-type="rangefor">
      for (int <input type="text" value="x"> : <input type="text" value="arr">) {
    </div>
  </div>
</div>

<div id="workspace">
  <div id="scriptArea">
    <h3>Script (inside main)</h3>
    <!-- script blocks go here -->
  </div>

  <div id="rightPane">
    <div id="cppCode"></div>
    <div id="output"></div>
    <div id="controls">
      <button class="btn" id="runBtn">RUN PROGRAM (SIMULATED)</button>
      <button class="btn" id="clearBtn">CLEAR SCRIPT</button>
    </div>
  </div>
</div>

<script>
  const scriptArea = document.getElementById("scriptArea");
  const cppCodeEl = document.getElementById("cppCode");
  const outputEl = document.getElementById("output");

  let scriptBlocks = [];
  let dragData = { type: null, fromList: null, index: -1 };
  let currentDropIndex = -1;
  let dropIndicator = null;

  function createDropIndicator() {
    const div = document.createElement("div");
    div.className = "drop-indicator";
    return div;
  }

  function refreshDropIndicator() {
    if (dropIndicator && dropIndicator.parentElement) {
      dropIndicator.parentElement.removeChild(dropIndicator);
    }
    dropIndicator = createDropIndicator();
    const blocks = [...scriptArea.querySelectorAll(".script-block")];
    if (currentDropIndex < 0 || currentDropIndex > blocks.length) return;
    if (blocks.length === 0 || currentDropIndex === blocks.length) {
      scriptArea.appendChild(dropIndicator);
    } else {
      scriptArea.insertBefore(dropIndicator, blocks[currentDropIndex]);
    }
  }

  document.addEventListener("dragstart", e => {
    const palette = e.target.closest(".palette-block");
    const scriptBlock = e.target.closest(".script-block");
    if (palette) {
      dragData.type = "palette";
      dragData.fromList = null;
      dragData.index = -1;
    } else if (scriptBlock) {
      dragData.type = "script";
      dragData.fromList = scriptBlocks.findIndex(b => b.el === scriptBlock);
      dragData.index = dragData.fromList;
    } else {
      dragData.type = null;
    }
  });

  document.addEventListener("dragend", () => {
    dragData.type = null;
    dragData.fromList = null;
    dragData.index = -1;
    currentDropIndex = -1;
    if (dropIndicator && dropIndicator.parentElement) {
      dropIndicator.parentElement.removeChild(dropIndicator);
    }
  });

  scriptArea.addEventListener("dragover", e => {
    e.preventDefault();
    const blocks = [...scriptArea.querySelectorAll(".script-block")];
    let idx = blocks.length;
    for (let i = 0; i < blocks.length; i++) {
      const rect = blocks[i].getBoundingClientRect();
      if (e.clientY < rect.top + rect.height / 2) {
        idx = i;
        break;
      }
    }
    currentDropIndex = idx;
    refreshDropIndicator();
  });

  scriptArea.addEventListener("drop", e => {
    e.preventDefault();
    const palette = e.dataTransfer ? null : null;
    if (!dragData.type) return;

    if (dragData.type === "palette") {
      const source = document.querySelector(".palette-block:active");
    }

    const targetPalette = document.querySelector(".palette-block:hover");
    let paletteBlock = null;
    if (dragData.type === "palette") {
      paletteBlock = document.querySelector(".palette-block[draggable='true']:active");
    }
    if (!paletteBlock && dragData.type === "palette") {
      const all = [...document.querySelectorAll(".palette-block")];
      paletteBlock = all.find(b => b.matches(":hover"));
    }

    if (dragData.type === "palette" && paletteBlock) {
      const newBlock = makeScriptBlockFromPalette(paletteBlock);
      insertScriptBlock(newBlock, currentDropIndex);
    } else if (dragData.type === "script" && dragData.fromList >= 0) {
      const moving = scriptBlocks[dragData.fromList];
      scriptBlocks.splice(dragData.fromList, 1);
      let insertIndex = currentDropIndex;
      if (insertIndex > scriptBlocks.length) insertIndex = scriptBlocks.length;
      scriptBlocks.splice(insertIndex, 0, moving);
      renderScriptBlocks();
    }

    currentDropIndex = -1;
    if (dropIndicator && dropIndicator.parentElement) {
      dropIndicator.parentElement.removeChild(dropIndicator);
    }
    updateCpp();
  });

  function makeScriptBlockFromPalette(paletteBlock) {
    const type = paletteBlock.dataset.type;
    const wrapper = document.createElement("div");
    wrapper.className = "script-block";
    wrapper.draggable = true;

    const handle = document.createElement("div");
    handle.className = "handle";
    wrapper.appendChild(handle);

    const inner = document.createElement("div");
    inner.className = "script-block-inner";
    inner.innerHTML = paletteBlock.innerHTML;
    wrapper.appendChild(inner);

    const remove = document.createElement("button");
    remove.className = "remove-btn";
    remove.textContent = "x";
    remove.onclick = () => {
      scriptBlocks = scriptBlocks.filter(b => b.el !== wrapper);
      renderScriptBlocks();
      updateCpp();
    };
    wrapper.appendChild(remove);

    wrapper.addEventListener("dragstart", e => {
      dragData.type = "script";
      dragData.fromList = scriptBlocks.findIndex(b => b.el === wrapper);
      dragData.index = dragData.fromList;
    });

    return { el: wrapper, type, getValues: () => readValues(inner) };
  }

  function insertScriptBlock(blockObj, index) {
    if (index < 0 || index > scriptBlocks.length) index = scriptBlocks.length;
    scriptBlocks.splice(index, 0, blockObj);
    renderScriptBlocks();
  }

  function renderScriptBlocks() {
    scriptArea.querySelectorAll(".script-block").forEach(b => b.remove());
    scriptBlocks.forEach(b => scriptArea.appendChild(b.el));
  }

  function readValues(container) {
    return [...container.querySelectorAll("input, select")].map(x => x.value);
  }

  function generateCpp() {
    let code = "";
    code += "#include <iostream>\n";
    code += "#include <string>\n";
    code += "using namespace std;\n\n";
    code += "void greet(string name) {\n";
    code += "    cout << \"Hello, \" << name << \"!\" << endl;\n";
    code += "}\n\n";
    code += "int main() {\n";

    let indent = 1;
    const tab = () => "    ".repeat(indent);

    scriptBlocks.forEach(b => {
      const t = b.type;
      const v = b.getValues();

      if (t === "print") {
        code += tab() + `cout << "${v[0]}";\n`;
      } else if (t === "printline") {
        code += tab() + `cout << "${v[0]}" << endl;\n`;
      } else if (t === "printvar") {
        code += tab() + `cout << ${v[0]} << endl;\n`;
      } else if (t === "callgreet") {
        code += tab() + `greet(${v[0]});\n`;
      } else if (t === "intdecl") {
        code += tab() + `int ${v[0]} = ${v[1]};\n`;
      } else if (t === "doubledecl") {
        code += tab() + `double ${v[0]} = ${v[1]};\n`;
      } else if (t === "chardecl") {
        code += tab() + `char ${v[0]} = '${v[1] || "A"}';\n`;
      } else if (t === "stringdecl") {
        code += tab() + `string ${v[0]} = "${v[1]}";\n`;
      } else if (t === "booldecl") {
        code += tab() + `bool ${v[0]} = ${v[1]};\n`;
      } else if (t === "assign") {
        code += tab() + `${v[0]} = ${v[1]};\n`;
      } else if (t === "inputint") {
        code += tab() + `cin >> ${v[0]};\n`;
      } else if (t === "inputprompt") {
        code += tab() + `cout << "${v[0]}";\n`;
      } else if (t === "mathprint") {
        code += tab() + `cout << "${v[0]}" << ${v[1]} << endl;\n`;
      } else if (t === "if") {
        code += tab() + `if (${v[0]}) {\n`;
        indent++;
      } else if (t === "elseif") {
        indent--;
        code += tab() + `else if (${v[0]}) {\n`;
        indent++;
      } else if (t === "else") {
        indent--;
        code += tab() + "else {\n";
        indent++;
      } else if (t === "for") {
        const varName = v[0] || "i";
        const start = v[1] || "1";
        const end = v[2] || "5";
        const name2 = v[3] || varName;
        code += tab() + `for (int ${varName} = ${start}; ${name2} <= ${end}; ${name2}++) {\n`;
        indent++;
      } else if (t === "while") {
        code += tab() + `while (${v[0]}) {\n`;
        indent++;
      } else if (t === "arraydecl") {
        code += tab() + `int ${v[0]}[5] = {1,2,3,4,5};\n`;
      } else if (t === "rangefor") {
        code += tab() + `for (int ${v[0]} : ${v[1]}) {\n`;
        indent++;
      } else if (t === "end") {
        indent = Math.max(1, indent - 1);
        code += tab() + "}\n";
      }
    });

    code += "    return 0;\n";
    code += "}\n";
    return code;
  }

  function simulateRun() {
    let out = "";
    function println(s) { out += s + "\n"; }
    function print(s) { out += s; }

    let env = {
      int: {},
      double: {},
      char: {},
      string: {},
      bool: {}
    };

    function getVal(expr) {
      try {
        const scope = {};
        Object.keys(env.int).forEach(k => scope[k] = env.int[k]);
        Object.keys(env.double).forEach(k => scope[k] = env.double[k]);
        Object.keys(env.bool).forEach(k => scope[k] = env.bool[k]);
        Object.keys(env.string).forEach(k => scope[k] = `"${env.string[k]}"`);
        const fn = new Function(...Object.keys(scope), "return " + expr + ";");
        return fn(...Object.values(scope));
      } catch {
        return 0;
      }
    }

    function execBlocks(blocks, start = 0, end = blocks.length) {
      let i = start;
      while (i < end) {
        const b = blocks[i];
        const t = b.type;
        const v = b.getValues();

        if (t === "print") {
          print(String(v[0]));
        } else if (t === "printline") {
          println(String(v[0]));
        } else if (t === "printvar") {
          const name = v[0];
          let val = env.int[name] ?? env.double[name] ?? env.bool[name] ?? env.string[name] ?? 0;
          println(String(val));
        } else if (t === "callgreet") {
          const name = v[0];
          let val = env.string[name] ?? name;
          println("Hello, " + val + "!");
        } else if (t === "intdecl") {
          env.int[v[0]] = Number(v[1]) || 0;
        } else if (t === "doubledecl") {
          env.double[v[0]] = Number(v[1]) || 0;
        } else if (t === "chardecl") {
          env.char[v[0]] = (v[1] || "A")[0];
        } else if (t === "stringdecl") {
          env.string[v[0]] = v[1];
        } else if (t === "booldecl") {
          env.bool[v[0]] = (v[1] === "true");
        } else if (t === "assign") {
          const name = v[0];
          const val = getVal(v[1]);
          if (name in env.int) env.int[name] = Number(val);
          else if (name in env.double) env.double[name] = Number(val);
          else if (name in env.bool) env.bool[name] = !!val;
          else env.int[name] = Number(val);
        } else if (t === "inputprompt") {
          print(String(v[0]));
        } else if (t === "inputint") {
          const name = v[0];
          const ans = prompt("Input for " + name + ":") || "0";
          env.int[name] = Number(ans) || 0;
        } else if (t === "mathprint") {
          const label = v[0];
          const val = getVal(v[1]);
          println(label + String(val));
        } else if (t === "if" || t === "elseif" || t === "else" ||
                   t === "for" || t === "while" || t === "rangefor") {
          let depth = 0;
          let j = i + 1;
          for (; j < end; j++) {
            const tt = blocks[j].type;
            if (["if","elseif","else","for","while","rangefor"].includes(tt)) depth++;
            if (tt === "end") {
              if (depth === 0) break;
              depth--;
            }
          }
          const bodyStart = i + 1;
          const bodyEnd = j;

          if (t === "if" || t === "elseif") {
            let cond = !!getVal(v[0]);
            if (cond) {
              execBlocks(blocks, bodyStart, bodyEnd);
              i = j;
            } else {
              i++;
              continue;
            }
          } else if (t === "else") {
            execBlocks(blocks, bodyStart, bodyEnd);
            i = j;
          } else if (t === "for") {
            const varName = v[0] || "i";
            const startVal = Number(v[1]) || 1;
            const endVal = Number(v[2]) || 5;
            env.int[varName] = startVal;
            for (; env.int[varName] <= endVal; env.int[varName]++) {
              execBlocks(blocks, bodyStart, bodyEnd);
            }
            i = j;
          } else if (t === "while") {
            while (getVal(v[0])) {
              execBlocks(blocks, bodyStart, bodyEnd);
            }
            i = j;
          } else if (t === "rangefor") {
            const varName = v[0] || "x";
            const arrName = v[1] || "arr";
            const arr = [1,2,3,4,5];
            for (let val of arr) {
              env.int[varName] = val;
              execBlocks(blocks, bodyStart, bodyEnd);
            }
            i = j;
          }
        }
        i++;
      }
    }

    execBlocks(scriptBlocks);
    outputEl.textContent = out || "(no output)";
  }

  document.getElementById("runBtn").onclick = () => {
    cppCodeEl.textContent = generateCpp();
    simulateRun();
  };

  document.getElementById("clearBtn").onclick = () => {
    scriptBlocks = [];
    renderScriptBlocks();
    cppCodeEl.textContent = generateCpp();
    outputEl.textContent = "";
  };

  cppCodeEl.textContent = generateCpp();
</script>

</body>
</html>
